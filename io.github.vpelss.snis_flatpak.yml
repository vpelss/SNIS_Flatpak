id: io.github.vpelss.snis_flatpak
runtime: org.freedesktop.Platform 
runtime-version: "24.08"
sdk: org.freedesktop.Sdk 
command: /app/bin/bin/snis_launcher #snis_launcher shell script needs to be run in folder with sub folders 'bin' and 'share'. I do not want to combine /app/bin/share folder and /app/share folder for aesthetic reasons

build-options:
  #append-ld-library-path: "/app/lib64/"
  #for some reason /app/lib64/pkgconfig/ is not in search path
  #append-pkg-config-path: "/app/lib64/pkgconfig/"

config-opts:
  - --enable-libopus # ? https://github.com/flatpak/freedesktop-sdk-images/blob/1.6/org.freedesktop.Sdk.json.in

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    version: '24.08'
    directory: lib/ffmpeg
    add-ld-path: .
cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib/ffmpeg

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --share=network
  - --socket=pulseaudio

cleanup:
  #- /bin/bin/snis_launcher
  
modules:

#see - --enable-libopus bove
# is that what theu meant
  #- name: opus
   # buildsystem: simple
    #build-commands: 
     # - ./configure
      #- make
      #- mkdir -p ${FLATPAK_DEST}/lib
      #- cp ./.libs/libopus.a ${FLATPAK_DEST}/lib/
    #sources:
     # - type: archive 
      #  url: https://archive.mozilla.org/pub/opus/opus-1.3.1.tar.gz
       # sha256: 65b58e1e25b2a114157014736a3d9dfeaad8d41be1c8179866f144a2fb44ff9d

  - name: lua
    buildsystem: simple
    build-commands: 
      - make generic
      - make linux
      - make local
      - mkdir -p ${FLATPAK_DEST}/include
      - mkdir -p ${FLATPAK_DEST}/lib
      - cp -r install/include/* ${FLATPAK_DEST}/include/
      - cp -r install/lib/* ${FLATPAK_DEST}/lib/
    sources:
      - type: archive 
        url: https://www.lua.org/ftp/lua-5.2.0.tar.gz
        sha256: cabe379465aa8e388988073d59b69e76ba0025429d2c1da80821a252cdf6be0d
 
  - name: portaudio
    buildsystem: cmake-ninja
    build-commands: 
    sources:
      - type: git
        url: https://github.com/PortAudio/portaudio.git
        commit: 242a0241f69bd359b692004f3974ce39ec5137fd #Aug 11, 2021

  - name: glu
    buildsystem: meson
    build-commands: 
    sources:
      - type: archive
        url: https://archive.mesa3d.org/glu/glu-9.0.3.tar.xz
        sha256: bd43fe12f374b1192eb15fe20e45ff456b9bc26ab57f0eee919f96ca0f8a330f

  - name: glew
    buildsystem: cmake-ninja
    config-opts: 
      # adds glew.pc for /app/lib/pkg-config folder
      - -D PKG_CONFIG_REPRESENTATIVE_TARGET=libglew_static
    build-commands: 
    sources:
      - type: git 
        url: https://github.com/Perlmint/glew-cmake.git
        commit: 72ff6b1a5ecfc1ae6154637298882744487634b4

  - name: snis
    buildsystem: simple
    build-commands:
      # some built library modules are not correctly reporting to pkg-config so LUALIBS=-llua       
      #- echo $HOME
      - make  PREFIX=${FLATPAK_DEST}/bin install WITHVOICECHAT=no -e LUALIBS=-llua       
      #- make install -e WITHVOICECHAT=no LUALIBS=-llua DESTDIR=/app/bin
      # makefile install option is broken  
      #- mkdir -p ${FLATPAK_DEST}/bin/bin
      #- cp -r snis_launcher ${FLATPAK_DEST}/bin
      #- cp -r bin/* ${FLATPAK_DEST}/bin/bin
      #- cp -r share/* ${FLATPAK_DEST}/bin/share
      - ls -l /app
      - ls -l /app/bin

      #copy compiled files to flatpak /app folder and set permissions
      #- mkdir -p /app/bin/bin
      #- mkdir -p /app/bin/share
      #copy it all, as there are tools everywhere
      #- cp -r * ${FLATPAK_DEST}/bin/
    sources:
      - type: git
        url: https://github.com/smcameron/space-nerds-in-space.git
        commit: 08f6aac98967858da463872c1cbe0d08ddba6c17 

  #author does not want to host these files on his git. I am hosting on /vpelss/snis_flatpak
  - name: snis_meta_icon_desktop
    buildsystem: simple
    build-commands:
      - install -Dm0644 logo.svg "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg"
      - install -Dm0644 ${FLATPAK_ID}.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
      - install -Dm0644 ${FLATPAK_ID}.desktop "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
    sources:
      - type: git
        url: https://github.com/vpelss/snis_flatpak.git
        commit: e82d7a175eda7d146088da2b0a28cfdf1fcfe386

  #- name: snis_wrapper
    #buildsystem: simple
    #build-commands:
      #- install -Dm777 snis.sh /app/bin/snis.sh
    #sources:
      #- type: script
        #dest-filename: snis.sh
        #commands:
          #- cd /app/bin
          #- exec ./snis_launcher
